/***************************************************************************/
/*                     ChangeLog of apcupsd                                */
/*               Kern Sibbald <kern at sibbald dot com>                    */
/*               http://www.apcupsd.com/                                   */
/*               http://sourceforge.net/projects/apcupsd                   */
/***************************************************************************/

----> Release apcupsd-3.10.7 (xx November 2003)
08Nov03
- Do automatic UPS detection in the USB code if no device is specified
  or if the specified device cannot be opened.
- Include patch provided by Howard Wilkinson, but put the new apcnet.c
  in apcnet.c.new until I have a chance to examine it in detail.

  His notes:
  I attach a complete rewrite of the Master side of the mast/slave code
  to support asynchronous connections to slaves.  I needed to do this as
  our network has a number of machines that tend to be powered off for
  long periods and the connect() calls were hanging around for more than
  nettime.
  I also, added a small patch for a new command line flag
  '-P|--pid-file' so that I can easily run multiple daemons on one
   machine.  I needed this as I have a machine that acts as a multiple
   master while getting its power from another UPS managed by another
   machine.
07Nov03
- Lib wrappers was not building correctly on FreeBSD due to the 
  library -lnls, so I copied over the Bacula code for configure.
  Thanks to Lars Köller for reporting this and for his patches.
- Attempt to get mkinstalldirs called by an absolute path rather
  than relative.
- Apply Lars' fixes to platforms/Makefile.in and platforms/etc/Makefile.in
  Install scripts with $(INSTALL_SCRIPT) instead of $(INSTALL_PROGRAM)
- Close all file descriptors except stdin/out/err.
- If there are no stdin/out/err (Windows), then create them and point them
  to /dev/null.  This prevents the serial port from suddenly getting
  debug output sent to it -- chaos.
- It seems that since the beginning of 3.10.x, the APCSMART_UPS never
  reported the proper status. This is because it was not in the case
  statement. Incredible since it is now the "standard" driver! Thanks
  to the user that brought this to my attention.
- Fix a segfault in linux-usb.c due to reference one beyond the command
  table. This happens only on newer USB UPSes. Thanks to the user who
  pointed this out.

----> Release apcupsd-3.10.6a (30 October 2003)
30Oct03
- Integrated Alexander Schremmer's stdout fix for Windows --
  keeps debug printout from being sent to the serial port.
28Oct03
- Bob Kuo found a bug that caused a seg fault for newer USB
  UPSes. The error was that my code walked off the end of a 
  table in linux-usb.c if the USB code was not in the
  table.

----> Release apcupsd-3.10.6 (10 October 2003)
11Oct03
- Release 3.10.6 10Oct03 as offical stable version.
03Oct03
- Move the old manual to old_documents and commit the
  new docbook manual to the CVS. Don't include the web
  html directory.
28Sep03
- Test net slave mode. It works fine.
- Add MASTER name to status output if device is a slave.
- Display last master update if device is a net slave.
- Add 10 sec delay before calling apcupsd --killpower it is
  needed for USB killpower to work right. Why????
- Save old apccontrol when installing a new one.
- Replace old UPS_SET() with set_ups() in a number of places.
27Sep03
- Implement autodetect of USB port if no DEVICE given.

----> Release apcupsd-3.10.6 (12 September 2003) Beta
14Sep03
- After the upgrade to RH9 with the new autoconf, quite a
  few things broke. As far as I can tell, it is because autoconf
  set top_srcdir to ., and since apcupsd exects top_srcdir to be
  absolute, lots of things broke.  Fixed by editing all the
  Makefiles and switching to topdir.
- Had to disable autoheader since it wipes out config.h.in
10Sep03
- Made pthreads default -- lots of problems converting to new
  autoconf -- it deleted my config.h.in file!
01Sep03
- Fixed bad file descriptor in SO_KEEPALIVE for slave (reported
  by Derek Battams.
- Added informative subject to email onbattery, ... (suggested
  by a user, thanks -- sorry I forgot who).
- #ifdef off IP6 code in inet_pton for platforms that do not have it.
06Aug03
- Added the -s "$MSG" to each of the script files (mainsback, ...)
  as suggested by Nicholas Robinson.
- The dependencies were not being correctly generated, so
  simplified the code. 
- Added install: to the include Makefile.in.  Lack of it 
  caused problems on OpenBSD.
- Changed LINEVOLT to MAINS in apcstatus.c to fix a problem   
  reported by David Walser of CGI reporting zero volts.
- Tried to clarify the difference between the net and
  the master/slave drivers in the doc.

----> Release apcupsd-3.10.6 (05 August 2003) Beta
05Aug03
- Because of the complaints about the master/slave code, I finally
  got around to testing it, and it was seriously broken in more
  than one way.  It seems to be working now.
- Started adding new set_ups() instead of UPS_SET().
- Adding the SIGCHLD broke quite a lot of calls in the master/slave
  code. This will probably also show up elsewhere.
04Aug03
- Tested the net driver, it seems to work perfectly fine. I
  did add a grace period of 4 seconds with comm loss on batteries
  before the shutdown is done.
- A number of changes to the manual.
- Clean up the net driver to be compatible with C++ for building
  on Windows.
- Ensure that we don't get stuck in a waitpid loop after calling
  apccontrol. Hopefully this will fix the 100% CPU usage on Win32
  after a power condition.

----> Release apcupsd-3.10.6 (18 July 2003)
18Jul03
- Reissue accept() immediately if interrupted rather than waiting.

----> Release apcupsd-3.10.6 (16 July 2003)
15Jul03
- In attempting to build the .cgi files on Windows, I realized that
  the gd1.2 code was no longer in the distribution.  Although some
  people were worried about the gif patent (I wasn't) it has now
  expired, so I see no reason why not to distribute the code as
  we always have. For the purists, it appears that the version you
  have on your system (png) will be used in preference to the local
  gd code.
- I backed out the 12July SNMP changes since they probably only
  work for 3 phase and I don't have the libraries to test compile
  or the card to test.

12Jul03
- Modify snmp driver to use upsPhaseOutputPercentPower instead of
  upsAdvOutputLoad as requested by ivac@gnjilux.srk.fer.hr.
08Jul03
- Added Sergey Vlasov's second USB kernel patch to the examples
  directory.  The two patches can be found in:
    linux-2.4.20-killpower.patch
    linux-2.4.20-USB-reject.patch
  The emails are also in that directory.
- As suggested by Sergey for the 2.5 kernel, I have #ifdefed
  out the call to HIDIOCGREPORT in the int_write routine used
  for killpower.
07Jul03
- Lots of updates to the document.
- Fixed a slave crash in master/slave mode. It was a missing setup_device,
  and was diagnosed and reported by Christian Schacht -- many thanks.

----> Release apcupsd-3.10.6 (30 May 2003)
30May03
- Made non-existent header files non-fatal and added #ifdef 
  around sys/socket.h so it will compile on IRIX.
- Add Scott's latest apcupsd.conf with the hid-ups program code 
  (actually I had done this some time ago ...).
- Start a ReleaseNotes file
20May03
- Fixed a typo error (mine) that prevented Scott from building
  rpms. Strange, it worked for me????
19May03
- More DESTDIR cleanup for building non-root rpms.
18May03
- Add DESTDIR everywhere so we can build rpms non-root
- Additional documentation
- Add Scott's new apcupsd.spec
06May03
- On Hilary Jones suggestion, I fixed the ./configure message that
  is printed when no libgd is found to direct the user to the
  main source.01May03
01May03
- Add Sergey Vlasov's kernel patch to the examples directory,
  and it replaces the previous patch.
  This patch now solves the killpower problem on Linux USB.
  <apcupsd-source>/examples/linux-2.4.20-alt-apc_usb_ups.patch
  notes are in: linux-usb-patch-email.txt
22Apr03
- Add TTY mode to apctest to communicated directly with UPS.
- Apply patch to linux-usb.c in killpower supplied by
  Sergey Vlasov (thanks!).
19Apr03
- Eliminate pow() function in linux-usb.c so that -lm is not needed.
14Apr03
- Add automatic detection of socklen_t
11Apr03
- I received a kernel patch from Sergey Vlasov that fixes
  the killpower problem on CS UPSes. apcupsd can now shutdown
  these devices! I've removed some debug code that was in
  the killpower routine and is not needed or used.
  I have put the kernel patch in:
    <apcupsd-source>/examples/linux-2.4.20-alt-hidups.patch
05Apr03
- When the Win32 version starts as a service, delete the
  NOLOGIN and PWRFAIL files to prevent later confusion.
  Thanks to Allen Crawford for pointing this out.
29Mar03
- Modify all Win32 program so that only windowed programs
  (apcupsd, popup) have the -mwindows flags. The others do not.
- Tweak apctest.c a bit -- add EEPROM programming (still a bit
  kludgy), but at least it can be done.
21Mar03
- Lots of clean ups for Cygwin stuff. Events now work, and exit.
- Clean up a few undefined symbols in building with everything on.
- Eliminate pid and serial port lock file on Win32 systems.
10Mar03
- Modify init script to use daemon so that STDIN/OUT, ... are   
  detached from the terminal and pointed to the log file. This
  prevents remotely logged in users who start apcupsd from being
  unable to log out.
06Mar03
- Made some mindor modifications to configure.in and aclocal.m4 to
  make consistent use of double quotes in test statements in
  response to problems with make install reported by Andrew Surratt.
- Thanks to Richard Schwaninger for finding and submitting a patch to
  the tcp-wrappers code that prevented it from working because of an
  invalid name. Fixed.
05Mar03
- Thanks to Andrew Reid for pointing out that the child reaping code
  should be clearing the pid slot if a -1 is returned. The pid table
  was filling up on his system due to killed children. Fixed
21Feb03
- A bug report against the Mandrake version of apcupsd indicates that
  apcupsd is not releasing /dev/console.  I've moved the close() of
  STDIN so that it is always executed to prevent this possibility.
12Feb03
- Implement very crude first cut of EEPROM programming in apctest.
  Set battery date, set UPS name, and print EEPROM values should
  work.

----> Release apcupsd-3.10.5 (03 Feb 2003)
03Feb03
- Added an avsnprinf() routine.          
- Replaced all vsprintf() calls with avsnprintf() to close a
  master/slave exploit that was published.
- Remove awk processing of halt script for Mandrake as suggested by
  David Walser.
02Feb03
- Corrected --enable-oldnet to be --enable-master-slave as I
  had intended. Thanks to David Walser for pointing this out.
- Added David Walser's apcupsd.spec.in for Mandrake and his
  changes to configure.in.

----> Release apcupsd-3.10.4 (28 Jan 2003)
28Jan03
- Fixed a lot of problems in the Win32 build (improper #ifdefing,
  missing prototypes, inet_pton not properly ifdeffed. Header files
  that are not available, ...)
- Modified make distclean to remove CVS directories (or most of them).
21Jan03
- Added error messages if old master/slave code called.
- Reworked the messages for ./configure --help to be aligned and
  clearer for networking and master/slave
- A number of important patches all supplied by Mirko Doelle.
- Moved technotes for 2001 and 2002 into respective directories.
- Created a new kes-3.10.4 file to which I will append if there
  are additional changes to 3.10.4. This will reduce the number
  of release note files.

Changes submitted this submission:
19Jan03
- Fixed hangs in usb driver startup when could not open port by
  releasing the ups structure lock before the Error_abort calls.
  Thanks to Mirko Doelle for reporting this.
- Fixed the default path for mkinstalldirs from $(topdir) to
  $(topdir)/autoconf.  Reported by Mirko.
- Fixed configure.in to always create platform/apccontrol. Previously
  it was not being created for Debian. Reported by Mirko.
- Removed Debian specific installation of apccontrol. Reported by
  Mirko.
- Implemented code to display the apcupsd events with the most recent
  first. Code sent by Mirko, but I modified it slightly.

----> Release apcupsd-3.10.3 (12 Dec 2002)
- Tried to correct problems with Makefiles
- Thanks to David Walser who pointed out where on the Sun, the make
  install was doing terrible things -- I found that there was
  a missing semicolon in the new Makefile.  Before my previous cleanup,
  there were actually 4 missing semicolons.  Hopefully this
  will correct the problem.
- For a second time, David Walser came to the rescue finding the
  CGI install problem reported by lots of people.  The new code
  used "make" instead of $(MAKE) to call the CGI make.  Fixed.

Changes submitted this submission:
- Removed Makefile code that creates and sets permission bits on
  /tmp $(prefix) and $(exec-prefix)
- Removed all occurrences of -z in the Makefiles (at least that I
  found) and replaced them with a more conservative formulation.
- Removed the install-symlinks script that caused some problems
  on distributions with blanks in the DISTVER name.
- Added install-symlinks to the suse Makefile.in. This is the
  only platform that currently uses it.


----> Release apcupsd-3.10.2 (08 Nov 2002)
- New cable design for BackUPS CS models to run it
  in Smart serial mode.
- Corrected a major bug in the smart and net code where the
  status word was getting clobbered.

Changes submitted this submission:
- A few days ago, slither_man sent me an email with some 
  information on how to run a BackUPS CS in smart mode with
  a serial cable.  He found the information by assuming that
  the UPS supported Smart mode and through trial and error.
  Well, it works!!!!!!! Amazing!!!! Thanks slither_man.
- Documentation for new CUSTOM-RJ54 cable that can be constructed
  from the end of an ethernet cable and a DB9F connector.

- Changed all the MAIL instances in shell scripts into APCUPSD_MAIL.
  This helps keep separated the apcupsd specific shell variables from
  the generic $MAIL shell variable that points to the user's mailbox:

    riccardo@ao:~> echo $MAIL
    /var/spool/mail/riccardo
    riccardo@ao:~>

  An user reported that ./configure script transformed internal $MAIL
  executable program into her mailbox path. This may happen if the
  configure suite is broken (thing that I don't want to check further).
  That said, APCUPSD_MAIL now should always correctly point to the
  system default mail client program.
- Made so that error_cleanup is a generic function called by the
  generic error handlers. Now if you want specific error_cleanup
  you don't need to write also specific error handlers, provided
  that error_cleanup don't accept parameters (i.e.
  specific_error_cleanup(void)) but if you want to have a specific
  error_cleanup with parameters you _must_ also write specific
  error_exit and error_out into which you will call the specific
  error_cleanup with parameters.
- Made so that error_exit and error_out are generic handlers that
  can be assigned, if needed, to specific handlers by the main() of
  each program. If not, the Error* routines will use the generic
  versions in apclib.a.
- Fixed wrong "true" usage in powerflute.
- Cleaned up the terminate() functions.
- Made DeviceVendor part of snmp DEVICE case insensitive.

----> Release apcupsd-3.10.1 (16 Sep 2002)
- Fixed a filling error with USB status dword.
- Fixed autoconf check and dependances of -lpanel,etc with -lncurses.
- Made more portable the apccontrol external scripts when calling the
  mailer (subject is now in the echo lines instead of relying on the
  presence of a -s switch on the mailer).
- Added gentoo platform.
- Added DESTDIR variable for platform packaging.
- Fixed a off-by-one problem in events table.
- Conditional compilation of old and new network code. Old network code
  disabled by default while new network code enabled by default.
- Removed old src/apcnet.c.old, old implementation of old networking.

----> Release apcupsd-3.10.0 (28 Jul 2002)
- Added documentation for SNMP UPSes. Documented the use of
  --kill-on-powerfail switch during shutdown.
- SuSE 8.0 is now supported.
- Added forward declaration of inet_pton and localtime_r when they
  are extraobj.
- Added inet_pton function. Implementation from Internet Software
  Consortium.
- Made sp_flags private to the dumb driver.
- Can't SET/CLEAR multiple flags: do them one by one. Fixed this
  bug in SNMP driver.
- Added 127A and 128A cables support for dumb UPSes.
- Implemented killpower for PowerNet MIB.
- Implemented the SNMP driver for APC's PowerNet MIB.
- Restructured UPSINFO so that now all the flags are contained
  into the Status bitmap.
- *BSD should compile cleanly again.
- Source tree is now under CVS revision control.
- Added support for listening on specific IP addresses/subnets in
  NIS server, from Troy.
- Doc updates, from Kern.

----> Release apcupsd-3.9.9 (18 May 2002)
- Applied final Kern's patch.
- Added a little program 'devicedbg' to help in debugging device
  drivers with gdb. To compile, 'make devicedbg' in src/.
- Cygwin platform added (reorganized old cygwin files).
- Darwin platform added.
- compile line is 'gcc -c -g -O2   -I../include  apcaction.c'.
- reviewed all the platform makefiles.
- use system libgd, searching for include files in system include dirs.
- in case system does not have libgd, uses provided libgd.
- put gd1.2 into master's contrib directory and a message if gd1.2
  is not present into src/gd1.2 (like default distribution will not)
  is issued at configure time to get gd1.2 from contrib and extract it
  into the src/ directory. Re-run config and all will be good and happy.
- Sources reorganization.
- Mandrake platform added.

----> Release apcupsd-3.9.8 (27 January 2002)
- New drivers layer adds new keywords to the UPSTYPE configuration
  variable (dumb, apcsmart, usb, snmp, net, and test). NOTE! only the
  first three are currently functional. All the old UPSTYPE keywords
  are translated into dumb or apcsmart for backward compatibility.   
  NOTE! snmp, net, and test drivers are experimental and thus
  largely non-functional.
- Reorganized developers documentation inside an html manual
  (Riccardo).
- Includes all enhancements to the officially released versions through
  3.8.5.
- Make drivers block a reasonable amount of
  time (maximum 1 minute, minimum 1 second). Blocking is determined
  by the state and functions requested.
- Many enhancements to the USB driver to support SmartUPSes (mostly).
- New code by Kamal to handle and truncate the events file.
- New smtp program to permit email messages from WinNT/Win2000 machines.
- Updates to apcaccess.
- New Dmsg() debug message code implemented.
- Include apctest Runtime Calibration feature.


----> Release apcupsd-3.9.4 Aug 13 2001
- Improvements in master/slave timeout detection and error messages.
- New master connect/disconnect events (accontrol).
- Additional master/slave documentation.
- Document USB.
- Updated manual to include ideas/suggestions received
  from users installing 3.8.2.
- Fixed safe.apccontrol to be a bit more system independent
  (thanks to Steven Orr for the idea).
- Added safe.apccontrol.in so that it is configured properly.
- Added a big warning message to the end of the ./configure
  output if /usr/ucb is on your path.
- Fixed reference to lock file in Solaris apcupsd.in so it is
  properly configured.
- Removed unused variable from Solaris apcupsd.in
- Added Makefile to examples directory
- Modified main Makefile.in to do clean and distclean of examples
- Additional documentation.
- Removed the sleep 2d from the halt script.
- Install apcupsd.conf with 644 permissions
- Add --disable-install-distdir ./configure option.
  This allows easier installation of slaves or
  multiple copies of apcupsd.
- Used makedepend if not gcc (Solaris fix).
- Set SO_REUSEADDR in slave machines.
- Add 940-0020C cable support (same as 20B).
- UPSNAME now sets upsname if given. Otherwise,
  apcupsd attempts to get name from UPS, if not found,
  uses hostname, finally "default".
- Implement CommLost NIS status.
- Implement Shutdown NIS status.
- Implement Slave NIS status.
- Correct SmartTrim and SmartBoost detection code.
- ./configure prints name of shutdown program.
- Add port to hosts.conf.
- Add new apccontrol arguments to script file.
- Add UPSNAME to RedHat apccontrol.
- Manual updates.
- Eliminated all N/A fields in STATUS report.
- Always construct STATFLAG in STATUS report.
- Added generic symlink installation in distributions/
- Cleanups of main Makefile.in
